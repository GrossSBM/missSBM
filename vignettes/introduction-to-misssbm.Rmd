---
title: "missSBM: a case study with war networks"
author: "missSBM team"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 4
bibliography: missSBMreferences.bib
link-citations: yes
vignette: >
  %\VignetteIndexEntry{missSBM: a case study with war networks}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE, 
  warning = FALSE,
  fig.width = 5, fig.height = 4)
```

## Prerequesites

On top of **missSBM**, our analysis will rely on the **igraph** package for network data manipulation, and **magrittr** to use the pipe operate `%>%`:

```{r package requirement, message=FALSE}
library(igraph)
library(magrittr)
library(missSBM)
```

## The war network

The `war_graphs` dataset comes with the `missSBM` package: 

```{r load data set}
data("war_graphs")
```

This dataset contains a list of two networks (`belligerent` and `alliance`) where the nodes are countries; an edge in the network `beligerent` means that the two countries have been at war at least once between years 1816 to 2007; an edge in network `alliance` means that the two countries have had a formal alliance between years 1816 to 2012.  The network `beligerent` have less nodes since countries which have not been at war are not considered.

These two networs were extracted from [](http://www.correlatesofwar.org/) (see @sarkees2010resort for war data, and  @gibler2008international for formal alliance).

```{r war network plot, fig.height=4, fig.width=8}
par(mfrow = c(1,2))
plot(war_graphs$alliance   , main = "Alliance")
plot(war_graphs$beligerent , main = "Beligerent")
par(mfrow = c(1,1))
```

### Generating missing data

Some data may be missing for some countries in the sense that data were collected comprehensively for a subset of countries and for the other countries we only observe their edges with the first subset and not within them. More precisely, we can assume that the sampling is node-centered and collect edges information accordingly (there will be a block of missing data on the diagonal of the adjacency matrix). To this end we rely on the function `sample` in **missSBM**:

```{r sampling node}
sampledNet_war <- war_graphs$beligerent %>% 
  as_adj(sparse = FALSE) %>% 
  missSBM::sample(sampling = "node", parameters = .8)
plot(sampledNet_war)
```

### Estimation with missing data

We can now adjust a Stochastic Block Model with the function `estimate` under this type of sampling:

```{r inference node, results='hide'}
vBlocks <- 1:6
collection_sbm <- missSBM::estimate(sampledNet_war, vBlocks = vBlocks, sampling = "node")
plot(collection_sbm$ICL, type = "l", xlab = "# blocks", ylab = "ICL", main = "raw ICL")
```

The `smooth` function allows the user to produce a smoothed version of the Integrated Classification Likelihood Criterion, commonly used to perform model selection. This will faciliate the choice of the number of group.

```{r smoothed node, results='hide'}
smooth(collection_sbm, "both")
plot(collection_sbm$ICL, type = "l", xlab = "# blocks", ylab = "ICL", main = "smoothed ICL")
```

### Estimation on fully observed network

We compare with clusterings obtained with the fully observed network.

```{r inference full, results='hide'}
collection_sbm_full <- war_graphs$beligerent %>% 
  as_adj(sparse = FALSE) %>% prepare_data() %>%  
  missSBM::estimate(vBlocks = vBlocks, "node", clusterInit = "hierarchical")
smooth(collection_sbm_full, "both")
plot(collection_sbm_full$ICL, type = "l", xlab = "# blocks", ylab = "ICL", main = "smoothed ICL on fully observed Network")
```


```{r clustering comparison}
table(
  collection_sbm$bestModel$fittedSBM$memberships,
  collection_sbm_full$bestModel$fittedSBM$memberships
  )
```

<!-- ### Taking the covariates into account -->

<!-- ```{r} -->
<!-- mil = load("../inst/covmilitarypower.Rdata") -->
<!-- cbind(belmilpow,get.vertex.attribute(war_graphs$beligerent)$name) #  get military power for countries in beligerent network -->
<!-- cbind(allmilpow,get.vertex.attribute(war_graphs$alliance)$name) #  get military power for countries in alliance network -->
<!-- ``` -->

## References
