---
title: "missSBM: a case study with war networks"
author: "missSBM team"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 3
bibliography: missSBMreferences.bib
link-citations: yes
vignette: >
  %\VignetteIndexEntry{missSBM: a case study with war networks}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE, 
  warning = FALSE,
  fig.width = 5, fig.height = 4)
# set.seed(9876) # set seed for reproducibility
set.seed(9877) # set seed for reproducibility
```

## Prerequesites

On top of **missSBM**, our analysis will rely on the **igraph** package for network data manipulation and **ggplot2** and **magrittr** for representation.

```{r package requirement, message=FALSE}
library(igraph)
library(ggplot2)
library(magrittr)
library(missSBM)
```

## The war network

The `war_graphs` dataset comes with the `missSBM` package:

```{r load data set}
data("war")
```

This dataset contains a list of two networks (`beligerent` and `alliance`) where the nodes are countries; an edge in the network `beligerent` means that the two countries have been at war at least once between years 1816 to 2007; an edge in network `alliance` means that the two countries have had a formal alliance between years 1816 to 2012.  The network `beligerent` have less nodes since countries which have not been at war are not considered.

These two networs were extracted from [http://www.correlatesofwar.org/](http://www.correlatesofwar.org/) (see @sarkees2010resort for war data, and  @gibler2008international for formal alliance). In the following, we focus on the network `war$beligerent`, which is provided as an igraph object:

```{r war network plot, fig.width=7,  fig.height=7}
par(mar = c(0,0,0,0))
plot(war$beligerent, 
     vertex.shape="none", vertex.label=V(war$beligerent)$name,
     vertex.label.color = "steel blue", vertex.label.font=1.5,
     vertex.label.cex=.6, edge.color="gray70", edge.width = 2)
```

To pursue our analysis, we extract the adjacency matrix of the network and a covariate on the vertices describing the military power of each country.

```{r beligenrent network}
beligerent_adjacency <- as_adj(war$beligerent, sparse = FALSE)
beligerent_power     <- war$beligerent$power
```

### Generating missing data

Some data may be missing for some countries in the sense that data were collected comprehensively for a subset of countries and for the other countries we only observe their edges with the first subset and not within them. More precisely, we can assume that the sampling is node-centered and collect edges information accordingly (there will be a block of missing data on the diagonal of the adjacency matrix). To this end we rely on the function `sample` in **missSBM**:

```{r sampling node}
sampledNet_war <- missSBM::sample(beligerent_adjacency, sampling = "node", parameters = .8)
plot(sampledNet_war)
```

### Estimation with missing data

We can now adjust a Stochastic Block Model with the function `estimate` under this type of sampling:

```{r inference node, results='hide'}
vBlocks <- 1:5
collection_sbm <- missSBM::estimate(sampledNet_war, vBlocks = vBlocks, sampling = "node")
res_unsmoothed <- data.frame(
  ICL     = collection_sbm$ICL,
  nBlocks = vBlocks, 
  type    = "raw"
)
```

The `smooth` function allows the user to produce a smoothed version of the Integrated Classification Likelihood Criterion, commonly used to perform model selection. This will faciliate the choice of the number of group.

```{r smoothed node, results='hide'}
smooth(collection_sbm, "both")
res_smoothed <- data.frame(
  ICL     = collection_sbm$ICL,
  nBlocks = vBlocks, 
  type    = "smoothed"
)
```

Let us now check that the smoothing did its job correctly:

```{r smoothing effect plot}
rbind(res_unsmoothed, res_smoothed) %>% 
  ggplot(aes(x = nBlocks, y = ICL, group = type, color = type)) + 
    geom_line() + theme_bw()
```


### Estimation on fully observed network

We would like to compare out results with the clustering obtained on the fully observed network.

So we first adjust a collection of SBM on the original adjacency matrix:

```{r inference full, results='hide'}
collection_sbm_full <- 
  missSBM::estimate(
    sampledNet  = prepare_data(beligerent_adjacency), 
    vBlocks     = vBlocks, 
    sampling    = "node"
  )
smooth(collection_sbm_full, "forward", control = list(iterates = 3))
```

As expected, the ICL on the fully observed network is better. But more interestingly, the number of group selected may differ in the the presence of missing data.

```{r plot comparison full}
res_missing <- res_smoothed
res_missing$type <- "missing"
res_full <- data.frame(
  ICL     = collection_sbm_full$ICL,
  nBlocks = vBlocks, 
  type    = "full"
)
rbind(res_missing, res_full) %>% 
  ggplot(aes(x = nBlocks, y = ICL, group = type, color = type)) + 
    geom_line() + theme_bw()

```

Indeed, two classes found on the fully observed network fuse in the SBM fitted on the partially observed network.


```{r clustering comparison}
table(
  collection_sbm$bestModel$fittedSBM$memberships,
  collection_sbm_full$bestModel$fittedSBM$memberships
  )
```

```{r plot, fig.width=7, fig.height=7}
par(mfrow = c(2,2))
plot(collection_sbm$bestModel$fittedSBM, type = "network")
plot(collection_sbm$bestModel$fittedSBM, type = "connectivity")
plot(collection_sbm_full$bestModel$fittedSBM, type = "network")
plot(collection_sbm_full$bestModel$fittedSBM, type = "connectivity")
```


### Taking the covariates into account

We now show how to introduce a covariate in the model. We consider a covariate reflecting the military power of the country repsented by the node. We typically expect  a part of the network to be explained by this covariate.  

Let us first prepare the data for missSBM inference on the full set of data 

```{r war network with covariates} 
sampleNet_cov <- prepare_data(beligerent_adjacency, list(beligerent_power)) 
``` 

Then we run the inference on the fully observed network 

```{r war network with covariates full, results = 'hide'} 
vBlocks <- 1:4
collection_sbm_cov_full <- estimate(sampleNet_cov, vBlocks = vBlocks, sampling = "dyad")
res_unsmoothed <- data.frame(
  ICL     = collection_sbm_cov_full$ICL,
  nBlocks = vBlocks, 
  type    = "raw"
)
smooth(collection_sbm_cov_full, "forward", control = list(iterates = 2)) 
res_smoothed <- data.frame(
  ICL     = collection_sbm_cov_full$ICL,
  nBlocks = vBlocks, 
  type    = "smoothed"
)
rbind(res_unsmoothed, res_smoothed) %>% 
  ggplot(aes(x = nBlocks, y = ICL, group = type, color = type)) + 
    geom_line() + theme_bw()
```

The military power seems to be a covariate with great influence since its effect is estimated to `r collection_sbm_cov_full$bestModel$fittedSBM$covarParam`.

<!-- Other way to take into account the covariate military power -->
<!-- ```{r war network with covariate 2} -->
<!-- nWar = nrow(beligerent_adjacency) -->
<!-- matsumpower = matrix(war$beligerent$power,nrow = nWar,ncol = nWar) + matrix(war$beligerent$power,nrow = nWar,ncol = nWar,byrow=T) -->
<!-- diag(matsumpower) = 0 # diagonal has to be set to 0  -->
<!-- sampleNet_cov2 <- prepare_data(beligerent_adjacency, list(matsumpower))  -->
<!-- ``` -->

<!-- ```{r war network with covariates full 2, results = 'hide'}  -->
<!-- collection_sbm_cov_full2 <- estimate(sampleNet_cov2, vBlocks = 1:5, sampling = "dyad")  -->
<!-- smooth(collection_sbm_cov_full2)  -->
<!-- plot(collection_sbm_cov_full2$ICL) -->
<!-- ```  -->
<!-- ```{r betacov2} -->
<!-- betacov2 = collection_sbm_cov_full2$bestModel$fittedSBM$covarParam -->
<!-- ``` -->

<!-- ### Sampling network according to covariate effect -->

<!-- We then sampled some observation according to the covariates and try to estimate the SBM with these missing entries.  -->

<!-- ```{r war network with covariates sampled, results = 'hide'}  -->
<!-- sampleNet_cov_miss <- missSBM::sample(beligerent_adjacency, sampling = "node", parameters = missSBM:::logistic(.95), covariates = list(war$beligerent$power))  -->
<!-- collection_sbm_cov_miss <- estimate(sampleNet_cov_miss, vBlocks = 1:5, sampling = "node")  -->
<!-- smooth(collection_sbm_cov_miss, "foward", control = list(iterate = 2))  -->
<!-- ```  -->

<!-- ```{r comparison war with covariates}  -->
<!-- res_full <- data.frame(  -->
<!--   ICL     = collection_sbm_cov_full$ICL,  -->
<!--   nBlocks = vBlocks,   -->
<!--   type    = "full"  -->
<!-- )  -->
<!-- res_miss <- data.frame(  -->
<!--   ICL     = collection_sbm_cov_miss$ICL,  -->
<!--   nBlocks = vBlocks,   -->
<!--   type    = "miss"  -->
<!-- )  -->
<!-- rbind(res_miss, res_full) %>%   -->
<!--   ggplot(aes(x = nBlocks, y = ICL, group = type, color = type)) +   -->
<!--     geom_line() + theme_bw()  -->
<!-- ```  -->

## References
